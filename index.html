const express = require('express');
const axios = require('axios');
const crypto = require('crypto');
const helmet = require('helmet');
const cors = require('cors');
const rateLimit = require('express-rate-limit');

const app = express();
app.use(helmet());
app.use(cors());
app.use(express.json());

// Rate limit
app.use(rateLimit({ windowMs: 15 * 60 * 1000, max: 100 }));

// AES helper
function encrypt(text, key, iv) {
  const cipher = crypto.createCipheriv('aes-256-cbc', key, iv);
  let encrypted = cipher.update(text, 'utf8', 'base64');
  encrypted += cipher.final('base64');
  return encrypted;
}

// Proxy route
app.get('/go', async (req, res) => {
  const url = req.query.url;
  if (!url) return res.status(400).send('Missing ?url=');

  try {
    const response = await axios.get(url, {
      headers: { 'User-Agent': 'Mozilla/5.0' }
    });

    const key = crypto.randomBytes(32);
    const iv = crypto.randomBytes(16);
    const encryptedBody = encrypt(response.data, key, iv);

    res.json({
      key: key.toString('base64'),
      iv: iv.toString('base64'),
      data: encryptedBody
    });
  } catch (err) {
    console.error('Error fetching:', err.message);
    res.status(500).send('Error fetching site.');
  }
});

const port = process.env.PORT || 3000;

// âœ… Use HTTP instead of HTTPS (no SSL errors)
app.listen(port, () => {
  console.log(`Secure proxy active on http://localhost:${port}`);
});
