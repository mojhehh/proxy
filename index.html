<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SecureProxy — Wispbyte Frontend</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b1020;--card:#0f1724;--muted:#9aa4b2;--accent:#7de3b2}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#071026 0%, #07172b 100%); color:#e6eef6; margin:0; padding:24px}
.wrap{max-width:980px;margin:0 auto}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:18px; box-shadow:0 6px 24px rgba(2,6,23,0.6); margin-bottom:16px}
h1{margin:0 0 12px 0;font-size:20px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input[type=text], input[type=url], textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;outline:none}
.row{display:flex;gap:12px}
.row > *{flex:1}
button{background:linear-gradient(90deg,var(--accent),#5ad9a0);border:none;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer;color:#042018}
.meta{font-family:monospace;font-size:13px;color:var(--muted);margin-top:8px}
pre{background:#071425;padding:12px;border-radius:8px;overflow:auto;max-height:320px}
.small{font-size:13px;color:var(--muted)}
.buttons{display:flex;gap:10px;margin-top:10px}
.ok{color:#7ef3b3} .err{color:#ff9b9b}
footer{margin-top:12px;color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>SecureProxy — Wispbyte Frontend</h1>
    <div class="small">Enter any URL to fetch through your proxy server.</div>

    <label>Target URL</label>
    <input id="targetUrl" type="url" placeholder="https://example.com" value="https://example.com">

    <label>MASTER_KEY_B64 (optional)</label>
    <input id="masterKey" type="text" placeholder="Paste MASTER_KEY_B64 to decrypt content">

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="fetchBtn">Fetch via Proxy</button>
      <button id="clearBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">Clear output</button>
    </div>

    <div class="meta" id="status" style="margin-top:10px">Status: idle</div>
  </div>

  <div class="card">
    <h1>Response JSON</h1>
    <pre id="jsonOut">—</pre>
    <div class="buttons" id="jsonButtons" style="display:none">
      <button id="downloadJson">Download JSON</button>
      <button id="downloadData">Download encrypted data</button>
    </div>
  </div>

  <div class="card">
    <h1>Decrypted / Preview</h1>
    <div class="small">If you provide the correct <code>MASTER_KEY_B64</code>, the page will try to unwrap and decrypt the envelope.</div>
    <div id="decryptStatus" class="meta">No decryption attempted.</div>
    <pre id="plainOut">—</pre>
    <div class="buttons" id="plainButtons" style="display:none">
      <button id="downloadPlain">Download plaintext</button>
    </div>
  </div>

  <footer>Ensure your Wispbyte proxy allows requests from this frontend's origin (CORS).</footer>
</div>

<script src="https://unpkg.com/pako@2.1.0/dist/pako.min.js"></script>
<script>
const PROXY_URL = "http://217.154.239.23:14299"; // Wispbyte proxy

function b64ToBytes(b){ return Uint8Array.from(atob(b), c=>c.charCodeAt(0)); }
function bytesToStr(u8){ return new TextDecoder().decode(u8); }
function concat(...arrays){ let total=arrays.reduce((s,a)=>s+(a?a.length:0),0); let out=new Uint8Array(total); let offset=0; for(const a of arrays){ if(!a) continue; out.set(a,offset); offset+=a.length; } return out; }
function el(id){ return document.getElementById(id); }
function setStatus(txt, kind){ el("status").textContent = "Status: "+txt; el("status").className=kind||""; }
function hide(id){ el(id).style.display="none"; }
function show(id){ el(id).style.display="flex"; }
function downloadBlob(blob,name){ const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url;a.download=name;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(url),5000); }

const jsonOut = el("jsonOut"), plainOut = el("plainOut"), decryptStatus = el("decryptStatus");

async function tryDecryptFull(obj, masterKeyB64){
  if(!obj.wrapped_key||!obj.wrapped_iv||!obj.wrapped_tag) throw new Error("Envelope missing");
  const outerCt=b64ToBytes(obj.wrapped_key), outerIv=b64ToBytes(obj.wrapped_iv), outerTag=b64ToBytes(obj.wrapped_tag);
  const ciphertextWithTag = concat(outerCt, outerTag);
  const masterBytes=b64ToBytes(masterKeyB64);
  const masterKey = await crypto.subtle.importKey("raw", masterBytes.buffer, "AES-GCM", false, ["decrypt"]);
  const envelopeBuf = await crypto.subtle.decrypt({name:"AES-GCM", iv: outerIv, tagLength:128}, masterKey, ciphertextWithTag);
  const envelope = JSON.parse(bytesToStr(new Uint8Array(envelopeBuf)));
  if(!envelope.aesKey||!envelope.aesIv) throw new Error("Envelope missing aesKey/aesIv");
  const innerCipher=b64ToBytes(obj.data||""), aesKey=b64ToBytes(envelope.aesKey), aesIv=b64ToBytes(envelope.aesIv);
  const aesSubKey = await crypto.subtle.importKey("raw", aesKey.buffer,"AES-CBC",false,["decrypt"]);
  let plainBuf = await crypto.subtle.decrypt({name:"AES-CBC",iv:aesIv},aesSubKey,innerCipher.buffer);
  let plainUint8 = new Uint8Array(plainBuf);
  if(obj.gzipped){ try{ return bytesToStr(pako.ungzip(plainUint8)); } catch(e){ return plainUint8; } } else { return bytesToStr(plainUint8); }
}

el("fetchBtn").onclick = async ()=>{
  setStatus("Fetching…","ok"); jsonOut.textContent="loading…"; plainOut.textContent="—"; decryptStatus.textContent="No decryption attempted."; hide("jsonButtons"); hide("plainButtons");
  try{
    const target = el("targetUrl").value.trim();
    const resp = await fetch(PROXY_URL+"/go?url="+encodeURIComponent(target));
    if(!resp.ok) throw new Error("HTTP "+resp.status);
    const j = await resp.json();
    jsonOut.textContent = JSON.stringify(j,null,2); show("jsonButtons"); setStatus("Got response","ok");
    el("downloadJson").onclick=()=>downloadBlob(new Blob([JSON.stringify(j,null,2)],{type:"application/json"}),"proxy-response.json");
    if(j.data){ const dataBytes=b64ToBytes(j.data); el("downloadData").onclick=()=>downloadBlob(new Blob([dataBytes.buffer]),"encrypted-data.bin"); }
    const masterKeyB64 = el("masterKey").value.trim();
    if(masterKeyB64){ decryptStatus.textContent="Decrypting…"; try{ const decrypted=await tryDecryptFull(j, masterKeyB64); plainOut.textContent=decrypted; show("plainButtons"); el("downloadPlain").onclick=()=>downloadBlob(new Blob([decrypted]),"decrypted.txt"); decryptStatus.textContent="Decryption success."; setStatus("Decrypted","ok"); }catch(e){ decryptStatus.textContent="Decryption failed: "+e.message; setStatus("Decrypt error","err"); } } 
  }catch(e){ setStatus("Error: "+e.message,"err"); jsonOut.textContent="—"; }
};

el("clearBtn").onclick = ()=>{
  jsonOut.textContent="—"; plainOut.textContent="—"; decryptStatus.textContent="No decryption attempted."; setStatus("idle"); hide("jsonButtons"); hide("plainButtons");
};
</script>
</body>
</html>
